# File use for common cleanup operations
# that affescts multiple files

. ./common-script

# Function that wraps sed substitute command. 
# It gets the following as parameters,
# regexp - 1 (assumes regexp to be escaped as required)
# substituition - 2
# input file - 3 (which is also, effectively, the output)
#
# Optional: output file - 4
#
# Effectively, it replaces the text in input file
# matching the regexp with the substituition text
# and  stores the output in the same file when an output
# file is not specified
sed_substitute() {
  if [ $# -lt 3 ]
  then
    error $FUNCTION_ERR_MSG
  fi

  input_file=$3
  # TODO Fix the repetitive use of $4
  if [ -z "$4" ]
  then
    output_file='.'"$input_file"'~'
  else
    output_file="$4"
  fi
  
  # Copy input file under a different name to
  # preserve permissions while also storing sed output
  cp $input_file $output_file

  sed 's:'"$1"':'"$2"':' <$input_file >$output_file

  if [ -z "$4" ]
  then
    mv $output_file $input_file
  fi
}

# Cleanup vim-script
# Fix the uncapitalized constants
vim_cleanup() {
  VIM_CONFIG='vim-config'
  found=`cat $VIM_CONFIG | grep -o '[a-z]*_size'`
  for found_instance in $found
  do
    changed_instance=`echo $found_instance | tr a-z A-Z`
    sed_substitute '\<'$found_instance'\>' $changed_instance $VIM_CONFIG
  done
  echo 'Vim cleanup success'
}

# Add exit status for error due to misuse of parameters
fix__exit_status() {
  files=`ls | grep -v 'script-cleaner'`
  for file in $files
  do
    echo "Processing $file.."
    sed_substitute 'error $FUNCTION_ERR_MSG' 'error $FUNCTION_ERR_MSG $EXIT_FATAL' $file
  done
}

fix__exit_status
